# PRD: 분리 레벨 선택 기능

## 1. 개요 (Overview)

### 목적
현재 PDF 분할 시 모든 북마크 레벨이 개별 파일로 생성되어 불필요하게 작은 파일들이 많이 생성되는 문제를 해결한다. 사용자가 원하는 레벨까지만 파일로 분리하고, 하위 레벨은 상위 파일에 포함되도록 한다.

### 범위
- **포함**: GUI에 분리 레벨 선택 UI 추가, 섹션 병합 로직 구현
- **제외**: CLI 인터페이스, 새로운 파일 포맷 지원

### 성공 기준
- 사용자가 분리 레벨을 선택할 수 있다
- 선택한 레벨까지만 개별 파일로 생성된다
- 하위 레벨 콘텐츠가 상위 파일에 올바르게 포함된다

## 2. 기능 명세 (Functional Specifications)

### 2.1 사용자 스토리
- As a 사용자, I want 분리 레벨을 선택, so that 의미 있는 단위로 파일을 분리할 수 있다

### 2.2 수락 기준 (Acceptance Criteria)
- [x] Given PDF 로드됨, When 섹션 목록 표시, Then 최대 레벨 자동 감지
- [x] Given 레벨 선택 UI, When 레벨 N 선택, Then 레벨 1~N 섹션만 파일로 분리
- [x] Given 레벨 N 선택, When 변환 실행, Then 레벨 N+1 이상 콘텐츠는 상위 레벨 N 파일에 포함
- [x] Given 레벨 1 선택, When 변환 실행, Then 최상위 섹션만 파일로 분리
- [x] Given "모든 레벨" 선택, When 변환 실행, Then 기존과 동일하게 모든 섹션 개별 파일

### 2.3 기능 상세

| 기능 ID | 설명 | 우선순위 | 상태 |
|---------|------|----------|------|
| F-001 | 최대 레벨 자동 감지 | P1 | Todo |
| F-002 | 분리 레벨 선택 콤보박스 | P1 | Todo |
| F-003 | 섹션 병합 로직 구현 | P1 | Todo |
| F-004 | 병합된 마크다운 생성 | P1 | Todo |

## 3. 기술 명세 (Technical Specifications)

### 3.1 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                        GUI (app.py)                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  분리 레벨 콤보박스: [모든 레벨 ▼]                    │   │
│  │  옵션: 모든 레벨, 레벨 1, 레벨 2, ... 레벨 N         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Core (pdf_reader.py)                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  get_max_level() → int                               │   │
│  │  get_sections_merged(split_level: int)              │   │
│  │    → List[MergedSection]                             │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 Core (md_converter.py)                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  convert_merged_section()                            │   │
│  │    - 상위 섹션 제목 + 하위 섹션들 포함               │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 데이터 모델

```python
@dataclass
class MergedSection:
    """병합된 섹션 정보"""
    parent: Section           # 상위 섹션 (파일명 기준)
    children: list[Section]   # 하위 섹션들 (포함될 콘텐츠)
```

### 3.3 의존성
- 기존 모듈: `pdf_reader.py`, `md_converter.py`, `app.py`
- 외부 라이브러리: 추가 없음

## 4. 테스트 계획 (Test Plan)

### 4.1 테스트 범위
- 단위 테스트: 레벨 감지, 섹션 병합 로직
- 통합 테스트: 전체 변환 파이프라인
- E2E: GUI 레벨 선택 → 파일 생성

### 4.2 테스트 케이스 개요

| TC-ID | 설명 | 타입 | 우선순위 |
|-------|------|------|----------|
| TC-001 | get_max_level()이 최대 레벨 반환 | Unit | P1 |
| TC-002 | 섹션 병합 - 레벨 1 선택 | Unit | P1 |
| TC-003 | 섹션 병합 - 레벨 2 선택 | Unit | P1 |
| TC-004 | 섹션 병합 - 모든 레벨 (기존 동작) | Unit | P1 |
| TC-005 | 빈 섹션 목록 처리 | Unit | P2 |
| TC-006 | 병합된 마크다운 내용 검증 | Unit | P1 |
| TC-007 | 변환 통합 테스트 | Integration | P1 |

## 5. 엣지 케이스 & 오류 처리

### 5.1 엣지 케이스
- 단일 레벨만 존재: 레벨 선택 무의미 → 기존 동작
- 레벨 간 격차 (1, 3 존재, 2 없음): 존재하는 레벨 기준 처리
- 빈 하위 섹션: 상위 섹션 콘텐츠만 포함

### 5.2 오류 시나리오
- PDF 로드 실패: 기존 오류 처리 유지
- 잘못된 레벨 값: 기본값(모든 레벨)으로 fallback

## 6. 비기능적 요구사항

### 6.1 성능
- 레벨 감지: < 10ms
- 섹션 병합: O(n) where n = 섹션 수

### 6.2 UX
- 레벨 선택 UI는 직관적이어야 함
- 기본값: "모든 레벨" (기존 동작 유지)

## 7. 구현 체크리스트

- [x] Phase 3: 테스트 작성 완료 (13개 테스트)
- [x] Phase 4: 구현 완료
- [x] Phase 5: 모든 테스트 통과 (13/13)
- [x] Phase 6: 코드 리뷰 통과
- [x] Phase 7: 문서화 완료

## 8. 변경된 파일

| 파일 | 변경 내용 |
|------|----------|
| `core/pdf_reader.py` | `MergedSection` 클래스, `get_max_level()`, `merge_sections_by_level()` 추가 |
| `core/md_converter.py` | `convert_merged_section()`, `save_merged_section()` 추가 |
| `gui/app.py` | 분리 레벨 콤보박스 UI, `_do_conversion_merged()` 추가 |
| `tests/test_split_level.py` | 13개 단위 테스트 |
